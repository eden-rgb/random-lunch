<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìŠ¤í‘¼ë©ìŠ¤ ëœë¤ëŸ°ì¹˜ ì‹ ì²­</title>

  <style>
    body { visibility: hidden; }

    @font-face {
      font-family: 'DungGeunMo';
      src: url('./DungGeunMo.woff2') format('woff2'),
           url('./DungGeunMo.woff') format('woff'),
           url('./DungGeunMo.eot') format('embedded-opentype');
      font-weight: normal;
      font-style: normal;
    }

    html, body {
      margin: 0; padding: 0;
      background-color: #000;
      font-family: 'DungGeunMo';
      overflow: hidden;
    }

    .card {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      width: 90%; max-width: 400px;
      text-align: center;
      z-index: 10;
      color: black;
    }

    .mode-select {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      font-family: 'DungGeunMo'; 
    }

    .mode-select button {
      width: 48%; padding: 12px; font-size: 16px;
      background: #00FFDD; border: none; border-radius: 8px;
      cursor: pointer;
      font-family: 'DungGeunMo'; 
    }

    .form-block {
      display: none; margin-top: 10px;
    }

    .form-block.active {
      display: block;
    }

    input[type="text"] {
      padding: 12px; width: 100%; font-size: 16px;
      border-radius: 8px; border: 1px solid #ccc;
      margin-top: 10px; margin-bottom: 10px;
      box-sizing: border-box;
      font-family: 'DungGeunMo'; 
    }

    button.submit {
      padding: 12px 20px; font-size: 16px;
      border: none; background-color: #00FFDD;
      color: black; border-radius: 8px;
      cursor: pointer; width: 100%;
      font-family: 'DungGeunMo'; 
    }

    .spinner {
      margin: 10px auto; border: 4px solid #eee;
      border-top: 4px solid #00FFDD; border-radius: 50%;
      width: 28px; height: 28px;
      animation: spin 1s linear infinite; display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .cancel-box {
      position: absolute; bottom: 30px; left: 50%;
      transform: translateX(-50%);
      background: #111; padding: 20px;
      border-radius: 20px; color: white;
      width: 90%; max-width: 400px; z-index: 10;
      box-shadow: 0 0 10px #00FFDD88;
      font-family: 'DungGeunMo'; 
    }

    .cancel-box button {
      background-color: #ccc; color: black;
      border-radius: 8px;
      border: none; padding: 10px 16px;
      font-family: 'DungGeunMo'; 
    }

    .cancel-input {
      overflow: hidden; max-height: 0;
      opacity: 0; transition: all 0.4s ease;
      font-family: 'DungGeunMo'; 
    }

    .cancel-input.show {
      max-height: 120px; opacity: 1; margin-top: 10px;
      font-family: 'DungGeunMo'; 
    }

    canvas {
      position: absolute; top: 0; left: 0;
    }
  </style>

  <script>
    const now = new Date();
    const deadline = new Date("2025-11-14T12:00:00+09:00");

    if (now >= deadline) {
      window.addEventListener("DOMContentLoaded", () => {
        document.body.innerHTML = `
          <style>
            body {
              background: #000; color: #fff;
              font-family: DungGeunMo;
              text-align: center; padding: 100px;
            }
          </style>
          <h1>ğŸ¥² ëœë¤ëŸ°ì¹˜ ì‹ ì²­ ë§ˆê°</h1>
          <p>ì‹ ì²­ì€ 10ì›” 17ì¼ 12ì‹œì— ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ë‹¤ìŒ ëœë¤ëŸ°ì¹˜ë¥¼ ê¸°ëŒ€í•´ì£¼ì„¸ìš”!</p>
        `;
      });
    } else {
      document.addEventListener("DOMContentLoaded", () => {
        document.body.style.visibility = "visible";
      });
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>
<body>
  <canvas></canvas>
  <div class="card">
    <h1>ğŸ¥— ëœë¤ëŸ°ì¹˜ ì‹ ì²­í•˜ê¸°</h1>
    <div class="mode-select">
      <button onclick="selectMode('solo')">ğŸ™‹ í˜¼ì ì‹ ì²­!</button>
      <button onclick="selectMode('pair')">ğŸ‘¯ ê°™ì´ ì‹ ì²­!</button>
    </div>
    <div id="solo-form" class="form-block">
      <input type="text" id="soloName" placeholder="ì´ë¦„ (ì˜ˆ: Isla)" />
      <button class="submit" onclick="submitSolo()">ì‹ ì²­ ğŸ±</button>
    </div>
    <div id="pair-form" class="form-block">
      <input type="text" id="pairName" placeholder="ë‚´ ì´ë¦„ (ì˜ˆ: Isla)" />
      <input type="text" id="partnerName" placeholder="ê°™ì´ ì‹ ì²­í•  ì‚¬ëŒ (ì˜ˆ: Claire)" />
      <button class="submit" onclick="submitPair()">ê°™ì´ ì‹ ì²­ ğŸ‘¯</button>
    </div>
    <div class="spinner" id="loader"></div>
    <div id="result" style="margin-top: 10px; font-weight: bold;"></div>
  </div>

  <div class="cancel-box">
    <p>ì‹ ì²­ì„ ì·¨ì†Œí•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</p>
    <button onclick="toggleCancel()">ì‹ ì²­ ì·¨ì†Œí•˜ê¸° âŒ</button>
    <div class="cancel-input" id="cancelInputWrap">
      <input type="text" id="cancelName" placeholder="ì´ë¦„ (ì˜ˆ: Isla)" />
      <button onclick="cancelForm()">ì·¨ì†Œ ğŸ˜¢</button>
    </div>
    <div id="cancelResult" style="margin-top: 10px; color: #0ff;"></div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx1kAB0OZeALCWsYRwDRi0MeQis8vi5bmdeHxeZtSkuEjjIUl5kqnMqtOXLfvPtAsZKMA/exec";
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1X0oWxxP0XuxRnw32x7vfp10U5UuZYj_KHi5rY1xftDk/gviz/tq?tqx=out:csv";

    const { Engine, Render, Runner, World, Bodies, Events } = Matter;
    const engine = Engine.create();
    engine.gravity.y = 1;
    engine.gravity.scale = 0.0005;
    const world = engine.world;
    const width = window.innerWidth;
    const height = window.innerHeight;
    const render = Render.create({
      element: document.body,
      engine: engine,
      options: { width, height, wireframes: false, background: '#000' }
    });
    Render.run(render);
    Runner.run(Runner.create(), engine);

    const formWall = Bodies.rectangle(width / 2, height / 2, 500, 400, { isStatic: true });
    const ground = Bodies.rectangle(width / 2, height + 25, width, 50, { isStatic: true });
    const leftWall = Bodies.rectangle(-25, height / 2, 50, height, { isStatic: true });
    const rightWall = Bodies.rectangle(width + 25, height / 2, 50, height, { isStatic: true });
    World.add(world, [formWall, ground, leftWall, rightWall]);

    const droppedNames = new Set();
    const emojis = ["ğŸ£","ğŸ”","ğŸ•","ğŸ™","ğŸŒ®","ğŸ¥ª","ğŸ±","ğŸœ","ğŸ¤","ğŸ¥Ÿ","ğŸ§","ğŸ©"];

    function dropName(text) {
      if (droppedNames.has(text)) return;
      droppedNames.add(text);
      const emoji = emojis[Math.floor(Math.random() * emojis.length)];
      const label = emoji + " " + text;
      const x = Math.random() * (width - 200) + 100;
      const box = Bodies.rectangle(x, -50, 180, 50, {
        restitution: 0.3,
        render: { visible: false },
        label: label
      });
      World.add(world, box);
    }

    Events.on(render, "afterRender", () => {
      const ctx = render.context;
      ctx.font = "42px 'DungGeunMo'";
      ctx.fillStyle = "#ffffff";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      world.bodies.forEach(body => {
        if (body.label && body.label !== "Rectangle Body") {
          ctx.fillText(body.label, body.position.x, body.position.y);
        }
      });
    });

    function selectMode(mode) {
      document.getElementById("solo-form").classList.remove("active");
      document.getElementById("pair-form").classList.remove("active");
      document.getElementById("loader").style.display = "none";
      document.getElementById("result").innerText = "";
      document.getElementById(mode + "-form").classList.add("active");
    }

    function submitSolo() {
      const name = document.getElementById("soloName").value.trim();
      if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

      const formData = new FormData();
      formData.append("names", name);

      document.getElementById("loader").style.display = "block";
      document.getElementById("result").innerText = "";

      fetch(GAS_URL, { method: "POST", body: formData })
        .then(res => res.text())
        .then(text => {
          document.getElementById("loader").style.display = "none";
          document.getElementById("result").innerText = text;
          dropName(name);
        })
        .catch(err => {
          console.error("âŒ ìš”ì²­ ì‹¤íŒ¨:", err);
          document.getElementById("loader").style.display = "none";
          document.getElementById("result").innerText = "ì˜¤ë¥˜ ë°œìƒ ğŸ˜¢ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        });
    }

    function submitPair() {
      const name = document.getElementById("pairName").value.trim();
      const partner = document.getElementById("partnerName").value.trim();
      if (!name || !partner) {
        alert("ë‘ ë¶„ì˜ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }

      const group = nextGroupCode(); // ê°€, ë‚˜, ë‹¤...
      const labeledNames = [group + name, group + partner];

      const formData = new FormData();
      formData.append("names", labeledNames.join(","));

      document.getElementById("loader").style.display = "block";
      document.getElementById("result").innerText = "";

      fetch(GAS_URL, { method: "POST", body: formData })
        .then(res => res.text())
        .then(text => {
          document.getElementById("loader").style.display = "none";
          document.getElementById("result").innerText = text;
          dropName(name);
          dropName(partner);
        })
        .catch(err => {
          console.error("âŒ ìš”ì²­ ì‹¤íŒ¨:", err);
          document.getElementById("loader").style.display = "none";
          document.getElementById("result").innerText = "ì˜¤ë¥˜ ë°œìƒ ğŸ˜¢ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        });
    }

    function toggleCancel() {
      document.getElementById("cancelInputWrap").classList.toggle("show");
    }

    /* âœ… ìˆ˜ì •ëœ ë¶€ë¶„: ì‹œíŠ¸ì—ì„œ ì‹¤ì œ ì €ì¥ëœ ì´ë¦„(ëŒ€ì†Œë¬¸ì/ì ‘ë‘ì–´ í¬í•¨)ì„ ì°¾ì•„ ê·¸ëŒ€ë¡œ ì „ì†¡
       + ì„±ê³µ ë©”ì‹œì§€ëŠ” ì ‘ë‘ í•œê¸€ ì œê±° í›„ í‘œì¤€ ë¬¸êµ¬ë¡œ í‘œì‹œ */
    async function cancelForm() {
      const input = document.getElementById("cancelName").value.trim();
      if (!input) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

      const normalize = (s) => s.replace(/^[ê°€-í£]/, '').toLowerCase(); // ì ‘ë‘ í•œê¸€ 1ê¸€ì ì œê±° + ì†Œë¬¸ì
      const target = normalize(input);

      let canonical = null; // ì‹œíŠ¸ì— ì €ì¥ëœ ì›ë¬¸(ì˜ˆ: "Isla" ë˜ëŠ” "ê°…Isla")
      try {
        const res = await fetch(SHEET_CSV_URL);
        const text = await res.text();
        const rows = text.trim().split("\n").slice(1);
        for (const row of rows) {
          const cols = row.split(",");
          const val = (cols[1] || "").replace(/^"|"$/g, '').trim(); // Bì—´ ì´ë¦„
          if (!val) continue;
          if (normalize(val) === target) { canonical = val; break; }
        }
      } catch (e) {
        console.error("CSV ë¡œë“œ ì‹¤íŒ¨:", e);
      }

      const nameToSend = canonical || input; // ë§¤ì¹­ë˜ë©´ ì›ë¬¸ ê·¸ëŒ€ë¡œ, ì—†ìœ¼ë©´ ì…ë ¥ê°’

      const formData = new FormData();
      formData.append("name", nameToSend);
      formData.append("action", "delete");

      fetch(GAS_URL, { method: "POST", body: formData })
        .then(res => res.text())
        .then(msg => {
          // âœ… í™”ë©´ í‘œì‹œìš© ì´ë¦„: ì ‘ë‘ í•œê¸€ ì œê±° + ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì¼€ì´ìŠ¤ ìœ ì§€
          const displayName = input.replace(/^[ê°€-í£]/, '');
          if (/ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤/.test(msg)) {
            document.getElementById("cancelResult").innerText = `${displayName}ë‹˜ì˜ ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`;
          } else {
            document.getElementById("cancelResult").innerText = msg;
          }

          // í™”ë©´ ì˜¤ë¸Œì íŠ¸ ì œê±° (ì…ë ¥ê°’ ê¸°ì¤€)
          const toRemove = world.bodies.find(
            b => b.label && b.label.toLowerCase().includes(input.toLowerCase())
          );
          if (toRemove) World.remove(world, toRemove);
          document.getElementById("cancelName").value = "";
        })
        .catch(err => {
          console.error("âŒ ìš”ì²­ ì‹¤íŒ¨:", err);
          document.getElementById("cancelResult").innerText = "ì·¨ì†Œ ì‹¤íŒ¨ ğŸ˜¢";
        });
    }

    window.onload = async () => {
      selectMode('solo');
      const res = await fetch(SHEET_CSV_URL);
      const text = await res.text();
      const rows = text.trim().split("\n").slice(1);
      const names = rows.map(row => row.split(",")[1].replace(/^"|"$/g, '')).filter(Boolean);
      let i = 0;
      const interval = setInterval(() => {
        if (i >= names.length) clearInterval(interval);
        else dropName(names[i++].replace(/^[ê°€-í•˜]/, ''));
      }, 600);
    };

    function nextGroupCode() {
      const min = 'ê°€'.charCodeAt(0);
      const max = 'í£'.charCodeAt(0);
      let charCode = parseInt(localStorage.getItem("currentGroupCharCode")) || min;
      const code = String.fromCharCode(charCode);
      charCode++;
      if (charCode > max) charCode = min;
      localStorage.setItem("currentGroupCharCode", charCode);
      return code;
    }

    const mouse = Matter.Mouse.create(render.canvas);
    render.mouse = mouse;

    Events.on(engine, "beforeUpdate", () => {
      const mousePos = mouse.position;
      world.bodies.forEach(body => {
        if (!body.isStatic && body.label && body.label !== "Rectangle Body") {
          const dx = body.position.x - mousePos.x;
          const dy = body.position.y - mousePos.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const effectRadius = 200;
          const strength = 0.08;
          if (dist < effectRadius) {
            const forceMagnitude = (1 - dist / effectRadius) * strength;
            const fx = (dx / dist) * forceMagnitude;
            const fy = (dy / dist) * forceMagnitude;
            Matter.Body.applyForce(body, body.position, { x: fx, y: fy });
          }
        }
      });
    });
  </script>
</body>
</html>
